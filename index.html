<html lang="en">

<head>
    <title>three.js - pointerlock controls</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
    <style>
        #blocker {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #instructions {
            width: 100%;
            height: 100%;

            display: -webkit-box;
            display: -moz-box;
            display: box;

            -webkit-box-orient: horizontal;
            -moz-box-orient: horizontal;
            box-orient: horizontal;

            -webkit-box-pack: center;
            -moz-box-pack: center;
            box-pack: center;

            -webkit-box-align: center;
            -moz-box-align: center;
            box-align: center;

            color: #ffffff;
            text-align: center;
            font-family: Arial;
            font-size: 14px;
            line-height: 24px;

            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="blocker" style="display: block;">

        <div id="instructions" style="">
            <span style="font-size:36px">Click to play</span>
            <br><br>
            Move: WASD<br>
            Jump: SPACE<br>
            Look: MOUSE
        </div>

    </div>

    <script type="module">

        import * as THREE from './js/three/build/three.module.js';

        import { PointerLockControls } from './js/three/examples/jsm/controls/PointerLockControls.js';

        var camera, scene, renderer, controls;

        var objects = [];

        var raycaster;

        var moveForward = false;
        var moveBackward = false;
        var moveLeft = false;
        var moveRight = false;
        var canJump = false;

        var prevTime = performance.now();
        var velocity = new THREE.Vector3();
        var direction = new THREE.Vector3();
        var vertex = new THREE.Vector3();
        var color = new THREE.Color();

        var serverCount = [
            {
                "id": 135,
                "index": 0,
                "name": "Knowles",
                "rangee": 4,
                "baie": 4,
                "position": 1,
                "nombre_u": 2
            },
            {
                "id": 507,
                "index": 1,
                "name": "Thornton",
                "rangee": 3,
                "baie": 2,
                "position": 17,
                "nombre_u": 4
            },
            {
                "id": 103,
                "index": 2,
                "name": "Stafford",
                "rangee": 2,
                "baie": 2,
                "position": 35,
                "nombre_u": 1
            },
            {
                "id": 329,
                "index": 3,
                "name": "Hines",
                "rangee": 3,
                "baie": 4,
                "position": 34,
                "nombre_u": 1
            },
            {
                "id": 155,
                "index": 4,
                "name": "Daniels",
                "rangee": 1,
                "baie": 2,
                "position": 26,
                "nombre_u": 2
            },
            {
                "id": 786,
                "index": 5,
                "name": "Cruz",
                "rangee": 1,
                "baie": 1,
                "position": 4,
                "nombre_u": 2
            },
            {
                "id": 981,
                "index": 6,
                "name": "Saunders",
                "rangee": 2,
                "baie": 2,
                "position": 30,
                "nombre_u": 1
            },
            {
                "id": 800,
                "index": 7,
                "name": "Boyer",
                "rangee": 2,
                "baie": 5,
                "position": 3,
                "nombre_u": 3
            },
            {
                "id": 222,
                "index": 8,
                "name": "Walter",
                "rangee": 2,
                "baie": 2,
                "position": 17,
                "nombre_u": 3
            },
            {
                "id": 365,
                "index": 9,
                "name": "Sanford",
                "rangee": 1,
                "baie": 7,
                "position": 38,
                "nombre_u": 2
            },
            {
                "id": 890,
                "index": 10,
                "name": "Carpenter",
                "rangee": 2,
                "baie": 4,
                "position": 29,
                "nombre_u": 3
            },
            {
                "id": 447,
                "index": 11,
                "name": "Mckay",
                "rangee": 2,
                "baie": 4,
                "position": 24,
                "nombre_u": 1
            },
            {
                "id": 643,
                "index": 12,
                "name": "Downs",
                "rangee": 4,
                "baie": 4,
                "position": 18,
                "nombre_u": 3
            },
            {
                "id": 771,
                "index": 13,
                "name": "Kidd",
                "rangee": 1,
                "baie": 4,
                "position": 40,
                "nombre_u": 1
            },
            {
                "id": 224,
                "index": 14,
                "name": "Duffy",
                "rangee": 4,
                "baie": 5,
                "position": 27,
                "nombre_u": 2
            },
            {
                "id": 858,
                "index": 15,
                "name": "Chen",
                "rangee": 4,
                "baie": 4,
                "position": 8,
                "nombre_u": 3
            },
            {
                "id": 364,
                "index": 16,
                "name": "Nicholson",
                "rangee": 1,
                "baie": 1,
                "position": 19,
                "nombre_u": 4
            },
            {
                "id": 67,
                "index": 17,
                "name": "Kirk",
                "rangee": 4,
                "baie": 4,
                "position": 26,
                "nombre_u": 1
            },
            {
                "id": 169,
                "index": 18,
                "name": "Christian",
                "rangee": 4,
                "baie": 1,
                "position": 42,
                "nombre_u": 2
            },
            {
                "id": 299,
                "index": 19,
                "name": "Stanton",
                "rangee": 3,
                "baie": 1,
                "position": 6,
                "nombre_u": 1
            },
            {
                "id": 851,
                "index": 20,
                "name": "Moon",
                "rangee": 1,
                "baie": 2,
                "position": 37,
                "nombre_u": 2
            },
            {
                "id": 774,
                "index": 21,
                "name": "Martinez",
                "rangee": 1,
                "baie": 1,
                "position": 38,
                "nombre_u": 2
            },
            {
                "id": 533,
                "index": 22,
                "name": "Cole",
                "rangee": 1,
                "baie": 4,
                "position": 26,
                "nombre_u": 1
            },
            {
                "id": 315,
                "index": 23,
                "name": "Cote",
                "rangee": 2,
                "baie": 4,
                "position": 21,
                "nombre_u": 4
            },
            {
                "id": 474,
                "index": 24,
                "name": "Madden",
                "rangee": 4,
                "baie": 5,
                "position": 10,
                "nombre_u": 2
            },
            {
                "id": 435,
                "index": 25,
                "name": "Parker",
                "rangee": 3,
                "baie": 1,
                "position": 29,
                "nombre_u": 1
            },
            {
                "id": 42,
                "index": 26,
                "name": "Schneider",
                "rangee": 2,
                "baie": 2,
                "position": 40,
                "nombre_u": 2
            },
            {
                "id": 962,
                "index": 27,
                "name": "Henderson",
                "rangee": 1,
                "baie": 2,
                "position": 19,
                "nombre_u": 4
            },
            {
                "id": 786,
                "index": 28,
                "name": "Lane",
                "rangee": 3,
                "baie": 2,
                "position": 23,
                "nombre_u": 1
            },
            {
                "id": 470,
                "index": 29,
                "name": "Byers",
                "rangee": 4,
                "baie": 5,
                "position": 1,
                "nombre_u": 4
            },
            {
                "id": 784,
                "index": 30,
                "name": "Snyder",
                "rangee": 4,
                "baie": 1,
                "position": 26,
                "nombre_u": 3
            },
            {
                "id": 436,
                "index": 31,
                "name": "Fisher",
                "rangee": 1,
                "baie": 1,
                "position": 40,
                "nombre_u": 1
            },
            {
                "id": 937,
                "index": 32,
                "name": "Lynch",
                "rangee": 3,
                "baie": 5,
                "position": 4,
                "nombre_u": 1
            },
            {
                "id": 743,
                "index": 33,
                "name": "Clarke",
                "rangee": 3,
                "baie": 7,
                "position": 21,
                "nombre_u": 2
            },
            {
                "id": 198,
                "index": 34,
                "name": "Head",
                "rangee": 2,
                "baie": 5,
                "position": 4,
                "nombre_u": 3
            },
            {
                "id": 782,
                "index": 35,
                "name": "Dillard",
                "rangee": 1,
                "baie": 1,
                "position": 28,
                "nombre_u": 3
            },
            {
                "id": 259,
                "index": 36,
                "name": "Pennington",
                "rangee": 4,
                "baie": 1,
                "position": 34,
                "nombre_u": 1
            },
            {
                "id": 13,
                "index": 37,
                "name": "Rowland",
                "rangee": 2,
                "baie": 1,
                "position": 27,
                "nombre_u": 4
            },
            {
                "id": 623,
                "index": 38,
                "name": "Fitzpatrick",
                "rangee": 3,
                "baie": 2,
                "position": 35,
                "nombre_u": 1
            },
            {
                "id": 992,
                "index": 39,
                "name": "Faulkner",
                "rangee": 4,
                "baie": 2,
                "position": 28,
                "nombre_u": 2
            }
        ];
        var decalageVerticalU = 84.25;
        var nombreRangee = 4; // nombre de rangées
        var nombreBaie = 8; // nombre de baies (clim comprises,on la compte comme une baie)
        var numberStack = 42; // nombre d'emplacements , ce sont les u, içi il y en a 42

        var drrmarginleft = 10; // décalage des rectangles de la gauche 
        var drrmargintop = 5; // décalage des rectangles 
        var drrHeightEmplacement = 0.7; // hauteur d'un rectangle emplacement, un U fais donc 18px
        var drrhauteur = numberStack * drrHeightEmplacement;// hauteur des rectangles "baies et rangées" en fonctions du nombre d'emplacements (U) et la hauteur d'un emplacement4
        var ecartEmplacement = numberStack * drrHeightEmplacement + 150;
        var decalageHorizontal = 106;
        var drrLargeurClim = 6;
        var drrLargeurBaie = 10;
        var drrHauteurBaie = numberStack * drrHeightEmplacement;
        var drrLargeurEmplacement = 9;
        var climStack = [3, 6]; // Positions réelles des clims
        var interRangee = 30; // nombre de pixel d'espace entre chaque rangée
        var drrlargeur = nombreBaie * drrLargeurBaie - (climStack.length * drrLargeurClim); // largeur des rectangles "RANGEE"
        var offset = 0;
        var saut = 0;
        var serverFounded = 0;
        var floorMargin = 15;
        var tailleU  = 0.714;
        var tailleBaie = 30;
        init();
        animate();

        function init() {

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.y = 10;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            scene.fog = new THREE.Fog(0xffffff, 0, 750);

            var light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
            light.position.set(0.5, 1, 0.75);
            scene.add(light);

            controls = new PointerLockControls(camera, document.body);

            var blocker = document.getElementById('blocker');
            var instructions = document.getElementById('instructions');

            instructions.addEventListener('click', function () {

                controls.lock();

            }, false);

            controls.addEventListener('lock', function () {

                instructions.style.display = 'none';
                blocker.style.display = 'none';

            });

            controls.addEventListener('unlock', function () {

                blocker.style.display = 'block';
                instructions.style.display = '';

            });

            scene.add(controls.getObject());

            var onKeyDown = function (event) {

                switch (event.keyCode) {

                    case 38: // up
                    case 90: // w
                        moveForward = true;
                        break;

                    case 37: // left
                    case 81: // a
                        moveLeft = true;
                        break;

                    case 40: // down
                    case 83: // s
                        moveBackward = true;
                        break;

                    case 39: // right
                    case 68: // d
                        moveRight = true;
                        break;

                    case 32: // space
                        if (canJump === true) velocity.y += 350;
                        canJump = false;
                        break;

                }

            };

            var onKeyUp = function (event) {

                switch (event.keyCode) {

                    case 38: // up
                    case 90: // w
                        moveForward = false;
                        break;

                    case 37: // left
                    case 81: // a
                        moveLeft = false;
                        break;

                    case 40: // down
                    case 83: // s
                        moveBackward = false;
                        break;

                    case 39: // right
                    case 68: // d
                        moveRight = false;
                        break;

                }

            };

            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false);

            raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, - 1, 0), 0, 10);

            // floor

            var floorGeometry = new THREE.PlaneBufferGeometry(500, 500, 100, 100);
            floorGeometry.rotateX(- Math.PI / 2);

            // vertex displacement

            var position = floorGeometry.attributes.position;

            // for (var i = 0, l = position.count; i < l; i++) {

            //     vertex.fromBufferAttribute(position, i);

            //     vertex.x += Math.random() * 20 - 10;
            //     vertex.y += Math.random() * 2;
            //     vertex.z += Math.random() * 20 - 10;

            //     position.setXYZ(i, vertex.x, vertex.y, vertex.z);

            // }

            floorGeometry = floorGeometry.toNonIndexed(); // ensure each face has unique vertices

            position = floorGeometry.attributes.position;
            var colors = [];
            var colorsRangee = [];
            var colorsBaie = [];

            for (var i = 0, l = position.count; i < l; i++) {

                color.setHSL(Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                colors.push(color.r, color.g, color.b);
                color.setHSL(0 / 8, 1, .5);
                colorsRangee.push(color.r, color.g, color.b);
                color.setHSL(0 / 8, 1, .7);
                colorsBaie.push(color.r, color.g, color.b);

            }

            floorGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            var floorMaterial = new THREE.MeshBasicMaterial({ vertexColors: true });

            var floor = new THREE.Mesh(floorGeometry, floorMaterial);
            scene.add(floor);

            // objects
             // 30 = 42
             //  ? = 1
            var boxBaie = new THREE.BoxBufferGeometry(10, tailleBaie, 5); //largeur,hauteur,profondeur            
            var boxRangee = new THREE.BoxBufferGeometry(drrlargeur, drrhauteur, 8)

            var boxClim = new THREE.BoxBufferGeometry(drrLargeurClim, 30, 8)

            boxBaie = boxBaie.toNonIndexed(); // ensure each face has unique vertices
            boxRangee = boxRangee.toNonIndexed(); // ensure each face has unique vertices

            boxClim = boxClim.toNonIndexed();

            position = boxBaie.attributes.position;
            colors = [];

            for (var i = 0, l = position.count; i < l; i++) {

                color.setHSL(Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                colors.push(color.r, color.g, color.b);

            }

            boxBaie.setAttribute('color', new THREE.Float32BufferAttribute(colorsBaie, 3));
            boxRangee.setAttribute('color', new THREE.Float32BufferAttribute(colorsRangee, 3));
            boxClim.setAttribute('color', new THREE.Float32BufferAttribute(colorsBaie, 3))



            for (var i = 1; i <= nombreRangee; i++) {
                offset = 0;
                var offsetStack = numberStack * drrHeightEmplacement * (i - 1);           // nombre d'emplacement par leur taille et par i   
                var positionHeight = (drrmargintop * (i - 1) + offsetStack + interRangee);
                var boxMaterial = new THREE.MeshPhongMaterial({ specular: 0xffffff, flatShading: true, vertexColors: true, transparent: true, opacity: 0.5 });
                boxMaterial.color.setHSL(Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                //console.log((drrLargeurBaie * (nombreBaie - climStack.length) + drrLargeurClim * climStack.length))
                var box = new THREE.Mesh(boxRangee, boxMaterial);
                box.position.x = offset;
                box.position.y = floorMargin;
                box.position.z = positionHeight;

                scene.add(box);
                objects.push(box);
                for (var j = 1; j <= nombreBaie; j++) { // baie 
                    var hauteurTexteBaie = positionHeight - 20; // -20 represente le nombre de pixel,afin de placer le texte juste au dessus de chaque baie
                    var countClim = 0;
                    if (climStack && isInArray(j, climStack)) {
                        countClim++;
                        var boxMaterial = new THREE.MeshPhongMaterial({ specular: 0xffffff, flatShading: true, vertexColors: true });
                        boxMaterial.color.setHSL(Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                        //console.log((drrLargeurBaie * (nombreBaie - climStack.length) + drrLargeurClim * climStack.length))
                        var box = new THREE.Mesh(boxClim, boxMaterial);

                        offset += 10;
                        console.log("clim offset = " + offset);
                        box.position.x = offset - 38;
                        box.position.y = floorMargin;
                        box.position.z = positionHeight;
                        scene.add(box);
                        objects.push(box);
                    }
                    else {

                        var sizeOfPreviousServer = 0;
                        var boxMaterial = new THREE.MeshPhongMaterial({ specular: 0xffffff, flatShading: true, vertexColors: true });
                        boxMaterial.color.setHSL(Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                        //console.log((drrLargeurBaie * (nombreBaie - climStack.length) + drrLargeurClim * climStack.length))
                        var box = new THREE.Mesh(boxBaie, boxMaterial);
                        offset += 10;
                        console.log("baie offset = " + offset);
                        box.position.x = offset - 38;
                        box.position.y = floorMargin;
                        box.position.z = positionHeight;

                        scene.add(box);
                        objects.push(box);
                        //boucle emplacement--------------------------------------------------------------------------------------------------------------------------------
                        for (var h = 1; h <= numberStack; h++) { // emplacements des serveurs situés dans les baies j (baie)
                            saut += 150

                            var neededKeys = ["rangee", "baie"]
                            //=  (75*4 + ((42*18*4)+56) - ((42*18)*0+75*0)-(18*0)-93 =  3287 px  , cette position correspond au premier emplacement placé. donc R1 B1 u42.
                            var positionUVertical = (drrmargintop * (nombreRangee) + (drrhauteur * (nombreRangee) + interRangee) - (drrhauteur * (i - 1) + drrmargintop * (i - 1))
                                - (drrHeightEmplacement * (h - 1))) - (75 + drrHeightEmplacement); // pos 1 = (2549+756) - h*taille
                            var positionTextVertical = -drrHeightEmplacement + (drrmargintop * (nombreRangee - 1) + (drrhauteur * (nombreRangee - 1)) + interRangee) - (drrhauteur * (i - 1) + drrmargintop * (i - 1)) + (drrHeightEmplacement * (h));
                            var positionTextHorizontal = offset - 102;
                            var findServer = false;

                            var serveurData = getServeurByRangeeBaiePosition(i, j, h);
                            if (serveurData != null) {
                                serverFounded++;
                                console.log(serveurData);
                                sizeOfPreviousServer = getServeurByRangeeBaiePosition(i, j, h - 1) != null ? getServeurByRangeeBaiePosition(i, j, h - 1).nombre_u : 0;
                                findServer = true;


                                var boxMaterial = new THREE.MeshPhongMaterial({ specular: 0xffffff, flatShading: true, vertexColors: true });
                                boxMaterial.color.setHSL(Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                                //console.log((drrLargeurBaie * (nombreBaie - climStack.length) + drrLargeurClim * climStack.length))
                                var boxEmplacement = new THREE.BoxBufferGeometry(drrLargeurEmplacement, serveurData.nombre_u*tailleU, 3)
                                boxEmplacement = boxEmplacement.toNonIndexed(); // ensure each face has unique vertices
                                boxEmplacement.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                                var box = new THREE.Mesh(boxEmplacement, boxMaterial);
                                box.position.x = offset - 38;
                                //pour placer en hauteur le serveur, il faut prendre en compte la position actuelle du serveur et aussi celle du précedent
                                box.position.y = serveurData.position + sizeOfPreviousServer;
                                console.log("server position : " + serveurData.position + " - PreviousServerSize : "+sizeOfPreviousServer)
                                box.position.z = positionHeight + 3;

                                scene.add(box);
                                objects.push(box);
                            }
                            if (!findServer) {       //ce if permet de savoir si un serveur est placé dans l'emplacement précédent afin d'adapter ou non la taille de l'emplacement concerné.
                                if (sizeOfPreviousServer > 0) {

                                    sizeOfPreviousServer--;
                                }
                                else {
                                    sizeOfPreviousServer = 0;

                                    //ici creer les emplacements vide

                                }


                            }
                        }
                    }
                }
                console.log("server founded : " + serverFounded);
            }




            function getServeurByRangeeBaiePosition(rangee, baie, position) {
                return serverCount.find(item => {
                    if (item.rangee == rangee && item.baie == baie && item.position == position) {
                        return item;
                    }
                    else {
                        return null
                    }
                })
            }

            function isInArray(value, array) {
                return array.indexOf(value) > -1;
            }
            //

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            //

            window.addEventListener('resize', onWindowResize, false);

        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);

        }

        function animate() {

            requestAnimationFrame(animate);

            if (controls.isLocked === true) {

                raycaster.ray.origin.copy(controls.getObject().position);
                raycaster.ray.origin.y -= 10;

                var intersections = raycaster.intersectObjects(objects);

                var onObject = intersections.length > 0;

                var time = performance.now();
                var delta = (time - prevTime) / 1000;

                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                velocity.y -= 9.8 * 100.0 * delta; // 100.0 = mass

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize(); // this ensures consistent movements in all directions

                if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

                if (onObject === true) {

                    velocity.y = Math.max(0, velocity.y);
                    canJump = true;

                }

                controls.moveRight(- velocity.x * delta);
                controls.moveForward(- velocity.z * delta);

                controls.getObject().position.y += (velocity.y * delta); // new behavior

                if (controls.getObject().position.y < 10) {

                    velocity.y = 0;
                    controls.getObject().position.y = 10;

                    canJump = true;

                }

                prevTime = time;

            }

            renderer.render(scene, camera);

        }

    </script>


</body>

</html>